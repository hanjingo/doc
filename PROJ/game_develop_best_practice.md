# 游戏开发最佳实践

[TOC]



## 1 模块复用

- IM
- Robot
- Log
- ...



[返回顶部](#游戏开发最佳实践)

## 2 性能

### 2.1 承载量估算

$h = \frac{a}{f}$

- `h` 最高承载人数
- `a` 服务端每秒处理消息的数量
- `f` 客户端消息发送频率

### 2.2 日活估算

$DAU=h \times n$

- `DAU` 日活跃用户
- `h`     最高承载人数
- `n`     常数（一般为3~5）



[返回顶部](#游戏开发最佳实践)

## 3 分布式系统设计

### 3.1 不同交互场景的区别

| 交互场景 | 代价 | 稳定性 | 承载量   | 延迟 |
| -------- | ---- | ------ | -------- | ---- |
| 同进程   | 很小 | 最好   | 低       | 小   |
| 同物理机 | 中等 | 中等   | 中等     | 小   |
| 跨物理机 | 大   | 差     | 接近无限 | 大   |

### 3.2 数据一致性

TODO



[返回顶部](#游戏开发最佳实践)

## 4 并发编程

### 4.1 多进程&多线程&协程

TODO

### 4.2 尽量缩短加锁临界区

TODO



[返回顶部](#游戏开发最佳实践)

## 5 数据库设计

### 5.1 KV数据表的优势

传统的关系型数据表比较适用于功能稳定的项目（如：各种web网站，论坛等），现代手游更新频率非常高，数据表格式变化大，关系型数据设计难以应对；

使用KV数据表，通过将数据序列化，数据库仅存储序列化后的二进制数据，无论数据结构怎么变化，都不需要修改数据表，可以构造稳定的数据库结构。

**例**

给某个有1千万条数据的表添加一项新的列，这一步操作花费的时间非常大，尤其在项目已上线的情况下，会造成非常大的延迟；

### 5.2 尽量减少数据库的I/O

TODO

### 5.3 合理的分表分库

如果一张表的列过多，每次查询都要全部加载，其中包含大量不需要的列数据，实际用到的只有很小的一部分，非常浪费资源；



[返回顶部](#游戏开发最佳实践)

## 6 协议设计

### 6.1 粘包

TODO

### 6.2 序列化

TODO



[返回顶部](#游戏开发最佳实践)

## 7 网络编程

### 7.1 防止多次释放资源

释放一个已经释放的资源（如：套接字...）会导致报错，需要用一些变量标记资源是否已经关闭；

### 7.2 PIPE信号导致进程终止

在TCP设计中，发送端向“套接字信息不匹配”的接受端发送数据时，接受端会回应复位信号（RST）；在Linux系统下，对“收到复位（RST）信号的套接字“调用`write`时，系统会向进程发送`SIGPIPE`信号，此信号的默认动作是终止进程。

上述特性有时候会造成程序莫名其妙的退出，例：

发送端向已销毁套接字的接受端发送数据时，发送端就会收到复位信号，导致发送端直接退出；

**解决办法：**

1. 屏蔽信号`SIGPIPE`；

### 7.3 缓冲区溢出

需要发送的数据太多，而写缓冲区容量又不够，会导致缓冲区溢出；

**解决办法：**

1. 设置大容量缓冲区
2. 使用可自动扩容的缓冲区

### 7.4 心跳机制设计

TODO



[返回顶部](#游戏开发最佳实践)

## 8 业务流程

### 8.1 正确关闭服务器

关闭服务器的一般顺序为：

1. 阻止新玩家接入

2. **缓慢**让所有玩家下线

   如果所有玩家同时下线，会给数据库造成非常大的压力，应该让玩家分批次缓慢下线；

3. 下线过程中保存玩家数据

   先保存玩家个人数据，然后再保存全局数据；

4. 完全关闭服务器

### 8.2 定时系统设计

- 错误的设计

  定时检查是否满足条件，一旦满足条件，则执行相关代码；

  存在的问题：

  1. 如果在定时检查的那一刻服务端刚好卡顿，错过了此检查时刻，造成检查失效；

- 正确的设计

  保存上一次检查的信息（如：上一次检查时间...），一旦错过检查时刻，可以通过比对上一次检查的信息，来判断是否错过了检查时刻；

### 8.3 断线重连模型

断线重连的一般过程为：

1. 游戏中...

2. 断线

   为了防止客户端断线时间过长导致资源占用，需要设置一个断线重连截止时间，超过这个时间就完全断开此链接，不再接受重连；

3. 连接

4. 客户端发送重连协议

   为了验证重连客户端的合法性，需要给每个客户端生成代表身份标识的密码；

5. 服务端回应重连成功

6. 服务端发送断线期间缓存的消息

   断线期间服务端可能会向客户端发送消息，由于这些消息不能传达，因此需要由gateway缓存起来，待客户端重连后发送；

7. 游戏继续...

### 8.4 同步算法

TODO



[返回顶部](#游戏开发最佳实践)

## 9 压测

### 9.1 压测数据统计方法

压测数据的统计方法：

1. 分析服务端日志
2. 压测工具自我统计



## 10 热更新

TODO



[返回顶部](#游戏开发最佳实践)

## 11 信息安全

### 11.1 基本原则

- 不信任客户端，要尽可能对客户端发过来的数据进行校验
- 尽可能将所有逻辑放到服务端计算

### 11.2 常见的漏洞

- 内容相关
  1. 负数漏洞（溢出漏洞）

- 网络相关
  1. 频繁请求（变速器）
  2. 封包
- 权限相关
  1. 透视



---

[返回顶部](#游戏开发最佳实践)

## 常用的游戏框架

- [skynet最佳实践](SKYNET/best_practice.md)

