# 缓存系统

[TOC]



## 指标

- 一致性
  - 最终一致性
  - 强一致性
- 并发量



## 缓存系统架构

TODO



## 数据一致性解决方案

### 方案一：先删缓存再更新数据库

- 写操作

  ```sequence
  Title: 方案一：缓存系统写数据
  消费者->缓存: 1.删除缓存数据
  消费者->数据库: 2.更新数据库信息
  消费者->缓存: 3.新增缓存数据
  ```

  1. 先删除缓存数据
  2. 更新数据库数据，避免脏数据
  3. 异步将数据刷回缓存

- 读操作

  ```sequence
  Title: 方案一：缓存系统读数据
  消费者->缓存: 1.读缓存数据
  缓存-->消费者: 缓存找不到数据
  消费者->数据库: 2.读数据库数据
  数据库-->消费者: 返回数据
  消费者->缓存: 3.修改缓存数据
  
  ```
  
  1. 读缓存数据
  2. 如果缓存找不到数据，去读数据库
  3. 异步将数据刷回缓存

#### 优点

1. 整个流程非常简单，适用于低并发场景

#### 缺点

1. 容灾不足

   "写1"时删除缓存失败怎么处理；如果继续执行，那一直读的缓存数据不就是错误数据了？

2. 并发问题

   - 写写并发

     如果多个服务同时更新数据库，无法保证操作顺序，会存在相互覆盖问题

   - 读写并发

     如果消费者A的读操作与消费者B的写操作同时进行；流程如下：

     1. B删除缓存数据v1

     2. A读缓存数据，缓存找不到数据

     3. A读数据库数据，数据库返回数据v1

     4. B将数据库的数据v1更新为v2

     5. B将v2刷回缓存

     6. A将v1刷回缓存

        此时A的“脏数据”会覆盖B已经修改过的缓存数据，此时缓存中还是v1，此方案无法保证最终一致性。

     示意图如下：

     ```sequence
     Title: 读写并发异常示意
     B->缓存: 1.删除缓存数据v1
     A->缓存: 2.读缓存数据
     缓存-->A: 缓存找不到数据
     A->数据库: 读数据库数据
     数据库-->A: 返回数据v1
     B->数据库: 更新数据库数据v2
     B->缓存: 更新缓存数据v2
     A->缓存: 更新缓存数据v1
     ```

### 方案二：先删缓存再更新数据库同时引入binlog机制

- 写操作
  1. 删除缓存数据
  2. 更新数据库
  3. 监听数据库的binlog，找到需要刷新的数据
  4. 读数据库数据
  5. 把读到的数据写入缓存
- 读操作
  1. 读缓存数据
  2. 如果缓存找不到数据，去读数据库
  3. 异步将数据刷回缓存

#### 优点

1. “写4”或“写5”如果失败，可以进行日志回放，再次重试
2. 无论“写1”是否成功，后面都会刷新缓存



## 缓存系统常见问题

### 1. 缓存穿透

缓存和数据库中都没有的数据，用户还是源源不断的发起请求，导致每次请求都会到数据库，从而压垮数据库

#### 解决方案

1. 业务层校验

   对用户发过来的请求进行检查，有问题直接拦截

2. 对于查找不到的数据，在redis中将其值设置为NULL，并设置较短的过期时间

3. 布隆过滤器

   利用布隆过滤器的特性，判断数据存不存在，存在才去查找

### 2. 缓存击穿

redis中一个热点key在失效的同时，大量的请求过来，这些请求全部到达数据库，压垮数据库

#### 解决方案

1. 设置热点数据永不过期

   对于频繁读取的数据设置其永不过期

2. 定时更新过期时间

   在过期时间到来之前，去给它重新设置（续命）

3. 互斥锁

   利用一个redis中的数据值来作为锁标记，锁住时设置为1或true，释放锁时设置为0或false（记得设置过期，放置锁死）；要想修改数据库，得先拿到这个锁标记。


### 3. 缓存雪崩

redis中混存的数据大面积失效或者redis宕机，导致大量请求直接到数据库，压垮数据库。

#### 解决方案

1. 数据过期时间不要太密集，不要全都排到一起失效

2. 数据预热

   对于即将来临的大量请求，提前缓存到redis中

3. 保证redis高可用

   做集群



## 参考

- [缓存与数据库一致性系列-01](https://blog.kido.site/2018/12/01/db-and-cache-01/)
- [最全面的缓存架构设计（全是干货）](https://blog.csdn.net/zjttlance/article/details/80234341)
- [大型分布式系统中的缓存架构](https://www.cnblogs.com/panchanggui/p/9503666.html)
- [漫谈Web缓存架构](https://www.cnblogs.com/neal-ke/p/8966971.html)

