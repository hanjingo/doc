# Redis源码分析-压缩列表

[TOC]

压缩列表（ziplist）是列表键和哈希键的底层实现之一，当一个列表键只包含少量列表项，并且每个列表要么就是小整数值，要么就是长度比较短的字符串，那么Redis就会使用压缩列表来做列表键的底层实现；

例，执行以下命令将创建一个压缩列表实现的列表键：

```sh
redis> RPUSH lst 1 3 5 10086 "hello" "world"
redis> OBJECT ENCODING lst
```



## 压缩列表的构成

压缩列表的组成部分：

`|zlbytes|zltail|zllen|entry1|entry2|...|entryN|zlend|`

| 属性    | 类型     | 长度(字节) | 用途                                                         |
| ------- | -------- | ---------- | ------------------------------------------------------------ |
| zlbytes | uint32_t | 4          | 记录整个压缩列表占用的内存字节数：在对压缩列表进行内存重分配，或者计算zlend的位置时使用 |
| zltail  | uint32_t | 4          | 记录压缩列表表尾节点距离列表的起始地址有多少字节：通过这个偏移量，程序无须遍历整个压缩列表就可以确定表尾节点的地址 |
| zllen   | uint16_t | 2          | 记录了压缩列表包含的节点数量：当这个属性的值小于UINT16_MAX（65535）时，这个属性的值就是压缩列表包含节点的数量；当这个值等于UINT16_MAX时，节点的真实数量需要遍历整个压缩列表才能计算得出 |
| entryX  | 列表节点 | 不定       | 压缩列表包含的各个节点，节点的长度由节点保存的内容决定       |
| zlend   | uint8_t  | 1          | 特殊值0xFF（十进制255），用于标记压缩列表的末端              |

例，包含三个节点的压缩列表：

| zlbytes | zltail | zllen | entry1 | entry2 | entry3 | zlend |
| ------- | ------ | ----- | ------ | ------ | ------ | ----- |
| 0x50    | 0x3c   | 0x3   |        |        |        | 0xFF  |

- `zlbytes` 0x50(十进制80)，表示压缩列表的总长度为80字节；
- `zltail` 0x3c(十进制60)，表示如果有一个指向压缩列表起始地址的指针p，那么只要用p加上偏移量60，就可以计算出表尾节点entry3的地址；
- `zllen` 0x3(十进制3)，表示压缩列表包含3个节点；



## 压缩列表节点的构成

每个压缩列表节点由以下部分组成：

| previous_entry_length | encoding | content |
| --------------------- | -------- | ------- |
| 1~5字节               |          |         |

- previous_entry_length

  以字节为单位，记录了压缩列表中前一个节点的长度；根据前一个节点长度不同，属性的长度也有区别：

  - 前一节点的长度小于254字节：长度1字节；
  - 前一节点的长度大于等于254字节：长度5字节，第一个字节为`0x05`，后4个字节保存前一节点长度；

- encoding

  记录了节点的content属性所保存数据的类型以及长度；

  字节数组编码：

  | 编码                                              | 编码长度(字节) | content属性保存的值              |
  | ------------------------------------------------- | -------------- | -------------------------------- |
  | 00bbbbbb                                          | 1              | 长度小于等于63字节的字节数组     |
  | 01bbbbbb xxxxxxxx                                 | 2              | 长度小于等于16383字节的字节数组  |
  | 10_ _ _ _ _ _ aaaaaaaa bbbbbbbb cccccccc dddddddd | 5              | 长度小于等于4294967295的字节数组 |

  - `_` 表示留空
  - b, x 代表实际二进制数据

  整数编码：

  | 编码     | 编码长度(字节) | content属性保存的值                                          |
  | -------- | -------------- | ------------------------------------------------------------ |
  | 11000000 | 1              | int16_t类型的整数                                            |
  | 11010000 | 1              | int32_t类型的整数                                            |
  | 11100000 | 1              | int64_t类型的整数                                            |
  | 11110000 | 1              | 24位有符号整数                                               |
  | 11111110 | 1              | 8位有符号整数                                                |
  | 1111xxxx | 1              | 使用这一编码的节点没有相应的content属性，因为编码本身的xxxx四个位已经保存了一个介于0和12之间的值，所以它无须content属性 |

- content

  负责保存节点的值，节点值可以是一个字节数组或整数，值的类型和长度由节点的encoding属性决定；

例，保存字节数组“hello world”的节点：

| previous_entry_length | encoding | content       |
| --------------------- | -------- | ------------- |
| ...                   | 00001011 | "hello world" |



## 连锁更新

TODO



## 参考

### 文献

[1] 黄健宏.Redis设计与实现
