# Redis复制

数据库状态一致：进行复制中的主从服务器双方的数据库将保存相同的数据；



## 旧版复制功能的实现

### 同步

（sync），用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态。

```sequence
Title:示例
从服务器->主服务器: 发送SYNC命令
主服务器-->从服务器: 发送RDB文件
主服务器-->从服务器: 发送缓冲区保存的所有写命令
```

1. 从服务器向主服务器发送SYNC命令；
2. 收到SYNC命令的主服务器执行BGSAVE命令，在后台生成一个RDB文件，并使用一个缓冲区记录从现在开始执行的所有写命令；
3. 当主服务器的BGSAVE命令执行完毕时，主服务器会将BGSAVE命令生成的RDB文件发送给从服务器，从服务器接收并载入这个RDB文件，将自己的数据库状态更新至主服务器执行BGSAVE命令时的数据库状态；
4. 主服务器将记录在缓冲区里面所有写命令发送给从服务器，从服务器执行这些写命令，将自己的数据库状态更新至主服务器数据库当前所处的状态。

### 命令传播

（command propagate），用于在主服务器的数据库状态被修改，导致主从服务器的数据库状态出现不一致时，让主从服务器的数据库重新回到一致状态。



## 旧版复制功能的缺陷

从服务器对主服务器的复制可以分为2种情况：

- 初次复制：从服务器以前没有复制过任何主服务器，或者从服务器当前要复制的主服务器和上次一次复制的主服务器不同。
- 断线后重复制：处于命令传播阶段的主从服务器因为网络原因而中断了复制，但从服务器通过自动重连接重新连上了主服务器，并继续复制主服务器。

### SYNC命令是一个非常消耗资源的操作

每次执行SYNC命令，主从服务器需要执行以下动作：

1. 主服务器需要执行BGSAVE命令来生成RDB文件，这个生成操作**会耗费主服务器大量的CPU，内存和磁盘I/O资源**。
2. 主服务器需要将自己生成的RDB文件发送给从服务器，这个发送操作**会耗费主从服务器大量的网络资源（带宽和流量），并对主服务器响应命令请求的时间产生影响**。
3. 接收到RDB文件的从服务器需要载入主服务器发来的RDB文件，并且在载入期间，**从服务器会因为阻塞而没办法处理命令请求**。



## 新版复制功能的实现

PSYNC命令具有完整重同步（full resynchronization）和部分重同步（partial resynchronization）两种模式：

- 完整重同步：
- 部分重同步：



## 参考

- [Redis源码解析：16Resis主从复制之主节点的完全重同步流程](https://blog.csdn.net/gqtcgq/article/details/51241284)

