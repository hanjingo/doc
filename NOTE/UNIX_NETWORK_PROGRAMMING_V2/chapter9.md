# 第9章 记录上锁



## 9.1 概述

```c++
TODO
```

*文件上锁例子*



## 9.2 对比记录上锁与文件上锁



## 9.3 Posix fcntl记录上锁

```c++
#include <fcntl.h>
int fcntl(int fd, int cmd, ...);
```

- `fd` 文件描述符

- `cmd` 上锁命令

  - `F_SETLK` 获取/释放由`...`指向的flock结构所描述的锁；如果无法将该锁授予调用进程，立即返回一个EACCESS或EAGAIN错误而不阻塞。
  - `F_SETLKW` 同`F_SETLK`，但是为阻塞版本。
  - `F_GETLK` 检查由`...`指向的锁以确定是否有某个已存在的锁会妨碍将新锁授予调用进程。

- `...` 指向某个flock结构的指针

  ```c++
  struct flock {
      short l_type;
      short l_whence;
      off_t l_start;
      off_t l_len;
      pid_t l_pid;
  };
  ```

  - `l_type`

  - `l_whence` 字节偏移量

    | l_whence值 | 说明                                                         |
    | ---------- | ------------------------------------------------------------ |
    | `SEEK_SET` | `l_start`相对于文件的开头解释。                              |
    | `SEEK_CUR` | `l_start`相对于文件的当前字节偏移（即当前读写指针位置）解释。 |
    | `SEEK_END` | `l_start`相对于文件的末尾解释。                              |

  - `l_start` 便宜起始位置

  - `l_len` 从该偏移开始的连续字节数

  - `l_pid` 进程ID

- `返回值`

  成功：取决于cmd

  失败：-1

*记录上锁*

### 9.3.1 例子

```c++
TODO
```

*Posix fcntl上锁*

### 9.3.2 例子：简化用的宏

```c++
TODO
```

*调用fcntl获取或释放一个锁*

```c++
TODO
```

*调用fcntl测试一个锁*



## 9.4 劝告性上锁



## 9.5 强制性上锁



## 9.6 读出者和写入者的优先级

### 9.6.1 例子：某个写入锁待处理期间的额外读出锁

![9_7](res/9_7.png)

```c++
TODO
```

*确定在有一个写入锁待处理期间是否允许有另一个读出锁*

### 9.6.2 例子：等待着的写入者是否比等待着的读出者优先

```c++
TODO
```

*测试写入者是否比读出者优先*

![9_10](res/9_10.png)



## 9.7 启动一个守护进程的唯一副本

```c++
TODO
```

*确保某个程序只有一个副本在运行*



## 9.8 文件作锁用

```c++
TODO
```

*使用指定O_CREAT和O_EXEC标识的open实现的锁函数*



## 9.9 NFS上锁



## 9.10 小结

