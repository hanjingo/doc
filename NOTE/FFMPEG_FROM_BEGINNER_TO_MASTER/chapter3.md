# 第三章 FFmpeg转封装

## 音视频文件转MP4格式

### MP4格式标准介绍

MP4的格式信息:

- MP4文件由许多Box与FullBox组成
- 每个Box由Header和Data两部分组成
- FullBox是Box的扩展，其在Box结构的基础上，在Header中增加8位version标志和24位的flags标志
- Header包含了整个Box的长度的大小(size)和类型(type),当size等于0时，代表这个Box是文件的最后一个Box。当size等于1时，说明Box长度需要更多的位来描述，在后面会定义一个64位的largesize用来描述Box的长度。当Type为uuid时，说明这个Box中的数据是用户自定义扩展类型
- Data为Box的实际数据，可以是纯数据，也可以是更多的子Box
- 当一个Box中Data是一系列的子Box时，这个Box又可以称为Container(容器)Box

MP4常用参考标准排列方式

容器名: 一级，二级，三级，四级，五级，六级

| 一级 | 二级 | 三级 | 四级 | 五级 | 六级 | 必选 | 描述                                 |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ------------------------------------ |
| ftyp |      |      |      |      |      | *    | 文件类型                             |
| pdin |      |      |      |      |      |      | 下载进度信息                         |
| moov |      |      |      |      |      | *    | 音视频数据的metadata信息             |
|      | mvhd |      |      |      |      | *    | 电影文件头                           |
|      | trak |      |      |      |      | *    | 流的track                            |
|      |      | tkhd |      |      |      | *    | 流信息的track头                      |
|      |      | tref |      |      |      |      | track参考容器                        |
|      |      | edts |      |      |      |      | edit list容器                        |
|      |      |      | elst |      |      |      | edit list元素信息                    |
|      |      | mdia |      |      |      | *    | track里面的media信息                 |
|      |      |      | mdhd |      |      | *    | media信息头                          |
|      |      |      | hdr  |      |      | *    | media信息的句柄                      |
|      |      |      | minf |      |      | *    | media信息的容器                      |
|      |      |      |      | vmhd |      |      | 视频media头（只存在于视频的track）   |
|      |      |      |      | smhd |      |      | 音频media头（只存在于音频的track）   |
|      |      |      |      | hmdh |      |      | 提示meida头（只存在于提示的track）   |
|      |      |      |      | nmhd |      |      | 空media头（其他的track）             |
|      |      |      |      | dinf |      | *    | 数据信息容器                         |
|      |      |      |      |      | dref | *    | 数据参考容器，track中media的参考信息 |
|      |      |      |      | stb1 |      | * | 采样表容器，容器做时间与数据所在位置的描述 |
|      |      |      |      |      | stsd | * | 采样描述（codec类型与初始化信息） |
|      |      |      |      |      | stts |  | () |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |