# 第三章 处理机调度与死锁

[TOC]



## 处理机调度的层次和调度算法的目标

### 处理机调度的层次

1. 高级调度(High Level Scheduling)
2. 低级调度(Low Level Scheduling)
3. 中级调度(Intermediate Scheduling)

### 处理机调度算法的目标

1. 处理机调度算法的共同目标

   - 资源利用率

     $CPU的利用率=\frac{CPU有效工作时间}{CPU有效工作时间+CPU空闲等待时间}$

   - 公平性

   - 平衡性

   - 策略强制执行

2. 批处理系统的目标

   - 平均周转时间短

     平均周转时间：

     $T=\frac{1}{n}[\sum_{i=1}^{n} T_i]$

     平均带权周转时间：

     $W = \frac{1}{n} \sum_{i=1}^{n} \frac{T_i}{T_s}$

   - 系统吞吐量高

   - 处理机利用率高

3. 分时系统的目标

   - 响应时间快
   - 均衡性

4. 实时系统的目标

   - 截止时间的保证
   - 可预测性



## 作业与作业调度

### 批处理系统中的作业

1. 作业(Job)和作业步(Job Step)
2. 作业控制块(Job Control Block, JCB)
3. 作业运行的三个阶段和三种状态
   - 收容阶段
   - 运行阶段
   - 完成阶段

### 作业调度的主要任务

在每次执行作业调度（Admission Scheduling，接纳调度）时，需要做以下决定：

1. 接纳多少个作业
2. 接纳哪些作业

### 先来先服务(FCFS)和短作业优先(SJF)调度算法

1. 先来先服务(first-come first-served, FCFS)调度算法

2. 短作业优先(short job first, SJF)的调度算法

   缺点：

   - 必须预知作业的运行时间。
   - 对长作业非常不利，长作业的周转时间会明显地增长。
   - 在采用FCFS算法时，人-机无法实现交互。
   - 该调度算法完全未考虑作业的紧迫程度，故不能保证紧迫性作业能得到及时处理。

### 优先级调度算法和高响应比优先调度算法

1. 优先级调度算法(priority-scheduling algorithm, PSA)

2. 高响应比优先调度算法(Highest Response Ratio Next, HRRN)

   优先级变化规律：

   $优先权 = \frac{等待时间+要求服务时间}{要求服务时间}$

   由于等待时间与服务时间之和就是系统对该作业的响应时间，故该优先级又相当于响应比$R_p$；优先又可表示为：

   $R_p = \frac{等待时间+要求服务时间}{要求服务时间} = \frac{响应时间}{要求服务时间}$



## 进程调度

### 进程调度的任务，机制和方式

1. 进程调度的任务

   - 保存处理机的现场信息
   - 按某种算法选取进程
   - 把处理器分配给进程

2. 进程调度机制

   - 排队器

     ![3_1](res/3_1.png)

     *进程调度机制*

   - 分派器

   - 上下文切换器

3. 进程调度方式

   - 非抢占方式(Nonpreemptive Mode)

   - 抢占方式(Preemptive Mode)

     抢占主要原则有：

     1. `优先权原则` 指允许优先级高的新到进程抢占当前进程的处理机，即当有新进程到达时，如果它的优先级比正在执行进程的优先级高，则调度程序将剥夺当前进程的运行，将处理机分配给新到的优先权高的进程。
     2. `短进程优先原则` 指允许新到的短进程可以抢占当前长进程的处理机，即当新到达的进程比正在执行的进程明显短时，将处理机分配给新到的短进程。
     3. `时间片原则` 即各进程按时间片轮运行时，当正在执行的进程的一个时间片用完后，便停止该进程的执行而重新进行调度。

### 轮转调度算法

1. 轮转法的基本原理

2. 进程切换时机

3. 时间片大小的确定

   ![3_2](res/3_2.png)

   *时间片大小对响应时间的影响*

   ![3_3](res/3_3.png)

   *q=1和q=4时进程的周转时间*

### 优先级调度算法

1. 优先级调度算法的类型

   - 非抢占式优先级调度算法
   - 抢占式优先级调度算法

2. 优先级的类型

   - 静态优先级

     决定进程优先级大小的依据：

     - 进程类型
     - 进程对资源的需求
     - 用户要求

   - 动态优先级

### 多队列调度算法

TODO

### 多级反馈队列(multileved feedback queue)调度算法

1. 调度机制

   1. 设置多个就绪队列。按照优先级依次降低的顺序给每个队列赋值。

      ![3_4](res/3_4.png)

      *多级反馈队列调度算法*

   2. 每个队列都采用FCFS算法

   3. 按队列优先级调度

2. 调度算法的性能

   - 终端型用户
   - 短批处理作业用户
   - 长批处理作业用户

### 基于公平原则的调度算法

1. 保证调度算法

   在实施公平调度算法时系统中必须具有这样一些功能：

   - 跟踪计算每个进程自创建以来已经执行的处理时间。
   - 计算每个进程应获得的处理机时间，即自创建以来的时间除以n。
   - 计算进程获得处理机时间的比率，即进程实际执行的处理时间和应获得的处理机时间之比。
   - 比较各进程获得处理机时间的比率。如进程A的比率最低，为0.5，而进程B的比率为0.8，进程C的比率为1.2等。
   - 调度程序应选择比率最小的进程将处理机分配给它，并让该进程一直运行，直到超过最接近它的进程比率为止。

2. 公平分享调度算法



## 实时调度

### 实现实时调度的基本条件

1. 提供必要的信息

   为了实现实时调度，系统应向调度程序提供有关任务的信息：

   - 就绪时间
   - 开始截止时间和完成截止时间
   - 处理时间
   - 资源要求
   - 优先级

2. 系统处理能力强

   在实时系统中，必须满足下面的限制条件系统才是可调度的：

   $\sum _{i=1}^{m} \frac {C_i}{P_i} \leq N$

   - $m$ 周期性硬实时任务个数
   - $C_i$ 处理时间
   - $P_i$ 周期时间

3. 采用抢占式调度机制

4. 具有快速切换机制

   该机制应具有如下两方面的能力：

   - 对中断的快速响应能力
   - 快速的任务分派能力

### 实时调度算法的分类

1. 非抢占式调度算法

   - 非抢占式轮转调度算法
   - 非抢占式优先调度算法

2. 抢占式调度算法

   - 基于时钟中断的抢占式优先级调度算法

   - 立即抢占(Immediate Preemption)的优先级调度算法

     ![3_5](res/3_5.png)

     *实时进度调度*

### 最早截止时间优先EDF(Earliest Deadline First)算法

1. 非抢占式调度方式用于非周期实时任务

   ![3_6](res/3_6.png)

   *EDF算法用于非抢占调度方式*

2. 抢占式调度方式用于周期实时任务

   ![3_7](res/3_7.png)

   *最早截止时间优先算法用于抢占调度方式之例*

### 最低松弛度优先LLF(Least Laxity First)算法

![3_8](res/3_8.png)

*A和B任务每次必须完成的时间*

![3_9](res/3_9.png)

*利用ELLF算法进行调度的情况*

### 优先级倒置(priority inversion problem)

1. 优先级倒置的形成

   ![3_10](res/3_10.png)

   *优先级倒置示意图*

   优先级：$P_1 > P_2 > P_3$

2. 优先级倒置的解决办法

   ![3_11](res/3_11.png)

   *采用了动态优先级继承方法的运行情况*



## 死锁概述

### 资源问题

1. 可重用性资源和消耗性资源

   - 可重用性资源

     可重用性资源是一种可供用户重复使用多次的资源，具有如下性质：

     - 每一个可重用性资源中的单元只能分配给一个进程使用，不允许多个进程共享。
     - 进程在使用可重用性资源时，须按照以下顺序：请求资源->使用资源->释放资源。
     - 系统中每一类可重用性资源中的单元数目是相对固定的，进程在运行期间既不能创建也不能删除它。

   - 可消耗性资源

     可消耗性资源是在进程运行期间，由进程动态创建和消耗的，具有如下性质：

     - 每一类可消耗性资源的单元数目在进程运行期间是可以不断变化的。
     - 进程在运行过程中可以不断地创造可消耗性资源的单元。
     - 进程在运行过程中可以请求多个可消耗性资源用于消耗。

2. 可抢占性资源和不可抢占性资源

   - 可抢占性资源
   - 不可抢占性资源

### 计算机系统中的死锁

1. 竞争不可抢占性资源引起死锁